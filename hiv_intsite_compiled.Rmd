---
title: "hiv_intsite_compiled"
author: "Vincent Wu"
date: "10/3/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# load pkgs
```{r, warning=FALSE, message=FALSE}
library(ggplot2)
library(tidyverse)
library(GenomicRanges)
library(hiAnnotator)
library(RColorBrewer)
library(scales)
library(circlize)
library(grid)
library(gridExtra)
library(TxDb.Hsapiens.UCSC.hg38.knownGene)
library(org.Hs.eg.db)
library(ChIPseeker)
library(BSgenome.Hsapiens.UCSC.hg38)
library(hotROCs)

source("scripts/mrc_generator.R")
source("scripts/heatmapMaker.R.R")
source("scripts/epigeneticFeatures.R")
source("scripts/random_site.R")
source("scripts/hiv_int_helper_fx.R")
```

# load and merge data files
```{r}
df_art <- readRDS("data/df_compiled_1-5.rds")
df_acute <- readRDS("data/df_compiled_6.rds")

df_compiled <- df_art %>%
  mutate(exp = "ART-treated") %>%
  bind_rows(df_acute %>% mutate(exp = "Acute"))

# NOTE: removing chrM sample, likely mappinga artifact.
df_compiled <- df_compiled %>%
  filter(seqnames != "chrM")

# NOTE: remove patients D/E (no paired pbmc)
df_compiled <- df_compiled %>%
  filter(!patient_anon %in% c("D", "E"))

df_compiled %>%
  dplyr::select(-patient) %>%
  saveRDS(file = "data/df_compiled_vincent.rds")

gr_compiled <- makeGRangesFromDataFrame(df_compiled,
                                        keep.extra.columns = TRUE)
```

# patient-wide simulations
```{r}
calc_overlap <- function(ids, bin_index) {
  abund_ids <- ids[duplicated(ids)]
  total_count <- 0
  
  for (i in abund_ids) {
    bin_count <- 0
    for (b in seq(2, length(bin_index) + 1, 1)) {
      start <- bin_index[b - 1]
      
      if (b == length(bin_index) + 1) {
        end <- length(ids)
      } else {
        end <- bin_index[b] - 1        
      }
      
      bin <- ids[start:end]
      if (sum(bin == i) > 0) {
        bin_count <- bin_count + 1
      }
    }
    
    if (bin_count >= 2) {
      total_count <- total_count + 1
    }
  }
  
  return(total_count)
}

uniq_patients <- unique(df_compiled$patient_anon)
graphs <- list()

for (p in uniq_patients) {
  print(paste("Running simulation for", p))
  
  trial_df <- df_compiled %>%
    filter(patient_anon == p) %>%
    mutate(location_cell = paste(location, cell, sep = "_")) %>%
    mutate(group_id = group_indices(., location_cell)) %>%
    arrange(group_id)
  
  bin_index <- which(!duplicated(trial_df$group_id))
  ids <- trial_df$posID
  weights <- trial_df$abund
  
  # make pool with correct abundances
  pool_ids <- rep(ids, times = floor(weights))
  
  # find weights by group
  g_sum_df <- trial_df %>%
    group_by(group_id) %>%
    summarise(g_sum = sum(floor(abund)))
  
  weights_grouped <- g_sum_df$g_sum
  
  # get expanded bins (bins that account for abundances)
  # bin_index_exp <- c(1, weights_grouped[1])
  # for (i in seq(2, length(weights_grouped) - 1)) {
  #   w <- weights_grouped[i]
  #   
  #   bin_index_exp <- c(bin_index_exp, bin_index_exp[length(bin_index_exp)] + w + 1)
  # }
  
  bin_index_exp <- cumsum(weights_grouped)
  bin_index_exp <- bin_index_exp[-length(bin_index_exp)] + 1
  bin_index_exp <- c(1, bin_index_exp)
  
  # calculate overlap
  act_overlaps <- sum(duplicated(ids))
  
  # run simulations for overlap
  test <- sapply(seq(1, 1000), function(x) {
    pool_scramble <- sample(pool_ids)
    calc_overlap(pool_scramble, bin_index_exp)
  })
  
  weights_grouped
  
  # print(paste("Actual overlaps:", act_overlaps))
  
  # clone_info <- trial_df %>% filter(abund > 1)
  # print(summary(clone_info$abund))
  
  g_df <-  data.frame(x = test)
  
  g <- ggplot(data = g_df, aes(x = test)) +
    # geom_histogram(fill = "#CCCCCC", color = "#AAAAAA") +
    geom_density(fill = "#CCCCCC", color = "#AAAAAA") +
    theme_classic() +
    labs(title = p)
  
  graphs[[p]] <- g
    
  ggsave(filename = paste("figs/global_overlap_dens_", p, ".png", sep = ""),
         plot = graphs[[p]],
         device = "png")
}

# multiplot(plotlist = graphs, cols = 2)
```

# compile dataset from published sources
```{r}
df <- read.csv("data/20191004_hiris.csv", header = TRUE, stringsAsFactors = FALSE) %>%
  filter(environment == "in vivo")

pmid_of_interest <- c("15163705", "17262715", "24968937", "25011556")

df_interest <- df %>%
  filter(pubmed_ids %in% pmid_of_interest) %>%
  mutate(strand = ifelse(orientation_in_landmark == "", "*",
                         ifelse(orientation_in_landmark == "F", "+", "-")))

gr_interest <- makeGRangesFromDataFrame(df_interest,
                                       keep.extra.columns = TRUE,
                                       seqnames.field = "landmark",
                                       start.field = "location",
                                       end.field = "location",
                                       strand.field = "strand")

gr_interest

ref <- make_ref("reference_hg38.rds")
gr_interest <- getSitesInFeature(gr_interest, ref, "in_gene")
gr_interest <- getNearestFeature(gr_interest, ref, "nearest_gene")

df_clonal <- data.frame(gr_interest) %>%
  filter(in_gene != "FALSE") %>%
  group_by(in_gene) %>%
  tally() %>%
  arrange(desc(n))

write.table(df_clonal,
            "historical_art_intsites.tsv",
            sep = "\t",
            row.names = FALSE,
            col.names = FALSE,
            quote = FALSE)
```

# Genomic Heatmaps
```{r}
# settings for heatmaps and files
filter_type <- "exp_location_epigenetic_heatmap"
heatmap_dir <- paste0("heatmaps/", filter_type)

df_art <- df_compiled %>%
  # filter(exp == "ART-treated") %>%
  mutate(refGenome = "hg38",
         type = "insertion",
         clonal = ifelse(abund > 1, "clonal", "single"),
         # sampleName = paste(exp, clonal, sep = "_"),
         sampleName = paste(exp, location, sep = "_"),
         position = as.numeric(str_extract(posID, "(?<=[+-])(\\d*$)")))

df_sites_meta <- df_art %>%
  group_by(sampleName) %>%
  dplyr::mutate(group_n = n()) %>%
  dplyr::filter(group_n >= 10) %>%
  dplyr::ungroup() %>%
  arrange(sampleName) %>%
  mutate(siteID = row_number(),
         gender = "m") %>%
  data.frame()

annot_ref <- file.path(normalizePath("annot_ref"))

sites_mrcs <- generate_mrcs(df_sites_meta)
sites_mrcs_genomic <- annotate_genomic(sites_mrcs, annot_ref)

sites_to_ROC_ordinary(sites_mrcs_genomic,
                      df_sites_meta[, c("siteID", "sampleName", "refGenome")],
                      heatmap_dir)

heatmap_to_ggplot2(heatmap_dir, "genomic", NULL, filter_type)
```

# Epigenetics heatmap
```{r}
histoneorder_for_heatmap <- epigenetic_features()
histoneorder_for_heatmap <- histoneorder_for_heatmap[!grepl("[-_]", histoneorder_for_heatmap)]
histoneorder_for_heatmap <- histoneorder_for_heatmap[!grepl("Nucleo", histoneorder_for_heatmap)]
histoneorder_for_heatmap <- str_sort(histoneorder_for_heatmap, numeric = TRUE)

inoutNuc <- 'yes'
windows <- c(10000)

todocombos <- expand.grid(setName=unique(sites_mrcs$sampleName),
                          histones=histoneorder_for_heatmap,
                          windows=windows,
                          stringsAsFactors=FALSE)

todocombos$histone_window <- with(todocombos,
                                  paste(histones, getWindowLabel(windows),sep="."))

todocombos$todo <- TRUE
rows <- todocombos$todo
todoHistones <- unique(todocombos$histones[rows])
todoWindows <- unique(todocombos$windows[rows])

annotPath <- "data/epigeneticData"
for (f in todoHistones) {
    message(f)
  
    load(file.path(annotPath, paste0(f, ".RData")))
    if(length(sites) > 1e6) {
        sites_mrcs <- getFeatureCounts(sites_mrcs, epigenData, f, width=todoWindows,
                                  doInChunks=TRUE)
    } else {
        sites_mrcs <- getFeatureCounts(sites_mrcs, epigenData, f, width=todoWindows)
    }
}

sites_to_ROC_ordinary(sites_mrcs,
                      df_sites_meta[, c("siteID", "sampleName", "refGenome")],
                      heatmap_dir)

heatmap_to_ggplot2(heatmap_dir, "epigenetic", histoneorder_for_heatmap, filter_type)

```



