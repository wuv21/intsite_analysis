---
title: "hiv_intsite_compiled"
author: "Vincent Wu"
date: "10/3/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# load pkgs
```{r, warning=FALSE, message=FALSE}
library(ggplot2)
library(tidyverse)
library(GenomicRanges)
library(hiAnnotator)
library(RColorBrewer)
library(scales)
library(fossil)
library(circlize)
library(grid)
library(TxDb.Hsapiens.UCSC.hg38.knownGene)
library(org.Hs.eg.db)
library(ChIPseeker)

source("scripts/hiv_int_helper_fx.R")
```

```{r}
uniq_sites_dir <- "data/"
uniq_sites_fn <- list.files(path = uniq_sites_dir,
                            pattern = "^unique_sites.*.csv")

process_uniq_sites <- function(fn) {
  fn_complete <- paste(uniq_sites_dir, fn, sep = "")
  
  f <- read.csv(fn_complete, stringsAsFactors = FALSE) %>%
    mutate(primer = ifelse(grepl("U3", sampleName), "U3", "U5"))
  
  f$new_posid <- sapply(seq_along(f$seqnames), find_bp, df = f)
  
  # write.csv(x = f,
  #           file = paste(uniq_sites_dir, "proc_", fn, sep = ""),
  #           quote = FALSE,
  #           row.names = FALSE)
  
  return(f)
}

uniq_sites <- lapply(uniq_sites_fn, function(i) {process_uniq_sites(i)})

write.csv(bind_rows(uniq_sites),
          file = "data/comb_proc_unique_sites_acute.csv",
          row.names = FALSE,
          quote = FALSE)
```

# load and merge data files
```{r}
data_dir <- "~/Box/thesis_lab/exp/integration_site_6/analysis/data/"
sites_rds <- list.files(path = data_dir,
                        pattern = "standardized_uniq_sites.rds$",
                        recursive = TRUE)

process_rds <- function(fn, run_n) {
  raw_xofil_df <- readRDS(paste(data_dir, fn, sep = ""))$fil_uniq_sites %>%
    data.frame() %>%
    separate(samplename, sep = "-", into = c("main_id", "primer_id", "rep_id"), remove = FALSE) %>%
    mutate(rep_id = as.numeric(rep_id),
           seqnames = as.character(seqnames))
  
  raw_xofil_df$new_posid <- sapply(seq_along(raw_xofil_df$posid),
                                   find_bp,
                                   df = raw_xofil_df)
  raw_xofil_df$run <- run_n
  
  raw_xofil_df <- raw_xofil_df %>%
    arrange(samplename)
  
  return(raw_xofil_df)
}

sites_df <- lapply(seq_along(sites_rds), function(i) {process_rds(sites_rds[i], i)})

raw_xofil_df <- bind_rows(sites_df)

write.csv(raw_xofil_df,
          file = "data/raw_xofil_df_acute.csv",
          row.names = FALSE,
          quote = FALSE)
```

